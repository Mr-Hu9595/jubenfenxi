<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>预览：{{ sheet_name }}</title>
  <style>
    body { font-family: -apple-system, Arial, sans-serif; margin: 24px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 13px; }
    th { background: #f5f5f5; }
    caption { text-align: left; font-weight: bold; margin-bottom: 8px; }
    .alert { border: 1px solid #dbeafe; background:#eff6ff; color:#0b3a66; border-radius:6px; padding:10px; margin: 8px 0 14px; }
    .alert strong { color:#0b3a66; }
    .small { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <div style="margin-bottom:10px;">
    {% if user %}
      <span>已登录：{{ user.username }}</span>
      &nbsp;|&nbsp;
      <a href="/logout">退出登录</a>
    {% else %}
      <a href="/login">登录</a>
      &nbsp;|&nbsp;
      <a href="/register">注册</a>
    {% endif %}
    &nbsp;|&nbsp;
    <a href="/">返回首页</a>
  </div>
  <h3>Excel 预览（工作表：{{ sheet_name }}）</h3>
  <p>Excel：{{ excel_path }}。公式预览为公式文本，实际数值需在 Excel 中计算。</p>
  {% if added or failed_count %}
  <div class="alert">
    {% if added %}
      <div><strong>导入成功：</strong>新增 {{ added }} 行。</div>
    {% endif %}
    {% if failed_count %}
      <div><strong>PDF 解析失败：</strong>共 {{ failed_count }} 个。请改用 txt/docx 文本版本。</div>
      <div class="small">失败文件：
        {% for fn in pdf_fails %}
          <span>{{ fn }}</span>{% if not loop.last %}，{% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
  {% endif %}
  <p>
    <a href="/download" target="_blank">另存为（下载 Excel）</a>
    &nbsp;|&nbsp;
    <a href="/app" target="_self">返回上传</a>
  </p>
  {% if compliance_rows %}
  <div class="alert">
    <div><strong>规则对齐摘要：</strong>按《项目规则》关键检查项为每行剧本做达标提示。</div>
    <style>
      .checks { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
      .check { padding:2px 6px; border-radius:4px; font-size:12px; border:1px solid #eee; }
      .ok { background:#ecfee8; color:#256b1c; border-color:#c6f0bd; }
      .warn { background:#fff9e6; color:#7a5e00; border-color:#f1e3ac; }
      .fail { background:#fff0f0; color:#9b1c1c; border-color:#f5c2c2; }
      .title { font-weight:600; margin-top:8px; }
    </style>
    {% for item in compliance_rows %}
      <div class="title">剧本：{{ item.title }}｜人物饱满度：{{ item.fullness_label }}（{{ item.fullness_score }}）</div>
      <div class="checks">
        {% for c in item.checks %}
          <span class="check {{ c.level }}" title="{{ c.hint }}">{{ '✅' if c.level == 'ok' else ('⚠️' if c.level == 'warn' else '❌') }} {{ c.name }}（{{ c.val }}）</span>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
  {% endif %}
  {% if trend_cfg and (trend_cfg.platforms or trend_cfg.last_updated) %}
  <div class="alert">
    <div><strong>舆情快照与依据：</strong>
      依据红果/抖音近月舆情与《项目规则》口径进行宣发与商业价值分析。
    </div>
    <div class="small">
      更新时间：{{ trend_cfg.last_updated or '未配置' }}。
      来源：
      {% if trend_cfg.sources %}
        {% for s in trend_cfg.sources %}
          <a href="{{ s.url }}" target="_blank">{{ s.name }}</a>{% if not loop.last %}；{% endif %}
        {% endfor %}
      {% else %}
        本地默认配置
      {% endif %}
    </div>
    <div class="small">
      抖音强势标签：
      {% if trend_cfg.platforms and trend_cfg.platforms.douyin %}
        {% for k in trend_cfg.platforms.douyin.strong_tags %}
          <span>{{ k }}</span>{% if not loop.last %}、{% endif %}
        {% endfor %}
      {% else %}未配置{% endif %}
      ；红果强势标签：
      {% if trend_cfg.platforms and trend_cfg.platforms.hongguo %}
        {% for k in trend_cfg.platforms.hongguo.strong_tags %}
          <span>{{ k }}</span>{% if not loop.last %}、{% endif %}
        {% endfor %}
      {% else %}未配置{% endif %}
    </div>
  </div>
  {% endif %}
  <table>
    <caption>前 50 行（最多 60 列）</caption>
    <thead>
      <tr>
        {% for h in header %}
        <th>{{ h }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
      <tr>
        {% for v in row %}
        <td>{{ v }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</body>
</html>